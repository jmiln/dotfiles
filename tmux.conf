# Configuration for tmux plugin manager
set-environment -gF TMUX_PLUGIN_MANAGER_PATH "#{HOME}/.config/tmux/plugins"
if "test ! -d '${TMUX_PLUGIN_MANAGER_PATH}/tpm'" {
    run "mkdir -p '${TMUX_PLUGIN_MANAGER_PATH}'"
    run "git clone https://github.com/tmux-plugins/tpm '${TMUX_PLUGIN_MANAGER_PATH}/tpm'"
    run "${TMUX_PLUGIN_MANAGER_PATH}/tpm/bin/install_plugins"
}

### General {{{
    # Use UTF-8 encoding
    set -gq utf8
    set-window-option -gq utf8 on
    # Set scrollback history to 10,000 (10k)
    set -g history-limit 10000
    # Visual notification of activity in other windows
    setw -g monitor-activity on
    # No automatic renaming of windows (from commands on execution)
    set-window-option -g automatic-rename off
    # Set fucus-events to on for nvim
    set -g focus-events on

    set -s set-clipboard on
### }}}

### Key Bindings {{{
    # Key combination prefix is <C-Space>, not <C-b>
    unbind C-b
    unbind C-Space
    set -g prefix C-Space
    bind C-Space send-prefix # Hit it again for nested sessions?

    # Reload ~/.tmux.conf using Prefix+r
    bind r source-file -F "#{HOME}/.config/tmux/tmux.conf" \; display "Tmux config reloaded!"

    # Reduce the command delay time to something a bit shorter
    set -sg escape-time 1

    # Enable vi-mode
    setw -g mode-keys vi
    set -g status-keys vi

    # Prefix+Left/ Right arrow to move a window to one side or the other
    # TODO Figure out how to make this not conflict (Alt+arrow? / ctrl+shift+arrow?)
    # bind-key -r Left swap-window -t -1 \; select-window -t -1
    # bind-key -r Right swap-window -t +1 \; select-window -t +1
    bind -r "<" swap-window -d -t -1
    bind -r ">" swap-window -d -t +1

    bind-key -r Left select-pane -L
    bind-key -r Right select-pane -R

    # Copy mode to escape key
    unbind [
    bind-key Escape copy-mode                                       # enter copy mode, default is [
    bind-key -T copy-mode-vi Escape send-keys -X cancel             # exit copy-mode, or hit q
    bind-key  p paste-buffer                                        # paste
    bind-key  P choose-buffer                                       # choose which buffer to paste from
    bind-key -T copy-mode-vi v   send-keys -X begin-selection       # begin visual mode
    bind-key -T copy-mode-vi V   send-keys -X select-line           # visual line
    bind-key -T copy-mode-vi y   send-keys -X copy-selection        # yank/ copy
    bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle      # viual block toggle

    # Splitting and cycling
    bind-key "\\" split-window -h -c "#{pane_current_path}"        # Split pane vertically and focus current path
    bind-key "_"  split-window -v -c "#{pane_current_path}"        # Split pane horizontally and focus current path

    # Swapping windows/ tabs
    bind-key W choose-tree -w "swap-window -t '%%'"

    # Moving panes between windows
    bind-key M choose-tree -Zw "join-pane -t '%%'"

    # Rename window/ start it empty
    bind-key , command-prompt "rename-window '%%'"

    # List shortcuts
    bind-key ? list-keys
    # bind ? popup -h 80% -w 80% 'zsh -c "source ~/.fzf.zsh && comm -23 <(tmux list-keys | sort) <(tmux -L test -f /dev/null list-keys | sort)" | fzf'

    # Popup pane for quick use (Updating proper todo file)
    bind-key Bspace run-shell "~/.local/bin/find_todo_file.sh"

    # Popup pane for lazygit
    bind g display-popup -d "#{pane_current_path}" -xC -yC -w 95% -h 95% -E "lazygit"

    # Popup blank nvim
    bind ` display-popup -d "#{pane_current_path}" -xC -yC -w 95% -h 95% -E "nvim"

    # Popup pane for lazysql (Not sure what I'd bind it to)
    # bind ???? display-popup -d "#{pane_current_path}" -xC -yC -w 95% -h 95% -E "lazysql"

    # Tab / Window navigation
    bind -n C-PgDn next
    bind -n C-pageup prev
    bind C-Space last-window

    # Vi pane navigation (With prefix)
    bind h select-pane -L
    bind j select-pane -D
    bind k select-pane -U
    bind l select-pane -R

    # Switch panes using Alt-arrow without prefix
    bind -n M-Left  select-pane -L
    bind -n M-Right select-pane -R
    bind -n M-Up    select-pane -U
    bind -n M-Down  select-pane -D

    bind -r ] resize-pane -R 10
    bind -r [ resize-pane -L 10
    bind -r - resize-pane -D 10
    bind -r + resize-pane -U 10

    # Disable mouse control
    set -gq mouse-utf8 off
    setw -g mouse off
### }}}

### Appereance {{{
    # Better True Color support for Neovim
    # set -g default-terminal "tmux-256color"
    # set -ag terminal-overrides ",xterm-256color:RGB"
    set -g default-terminal "tmux-256color"
    set -ga terminal-overrides ",*256col*:Tc"
    set -ga terminal-overrides ',*:UTF-8'

    # Enhanced Undercurl support
    set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
    set -as terminal-overrides ',*:Setulc=\E[58::2::::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

    # Let pane/window numbers be 1-indexed
    set -g base-index 1
    set -g pane-base-index 1

    # Automatically renumber window numbers on closing a pane (tmux >= 1.7)
    set -g renumber-windows on

    # Set window notifications
    setw -g monitor-activity on
    set -g visual-activity off

    # Allow the arrow key to be used immediately after changing windows
    set -g repeat-time 0

    # Display tmux messages for 1 sec
    set -g display-time 1000

    # Set the title of the window outside the terminal (Putty, wezterm, etc)
    set -g set-titles on

    # Configure the string format of the window title
    set -g set-titles-string   '#W#F  #T'

    ## Status Bar {{
        # For special character sequences such as #S, refer to manual
        # #T      = standard window title
        # #h      = short hostname
        # #S      = session name
        # #I      = tmux window index
        # #W      = tmux window name

        # Turn the status bar on
        set -g status on

        # Update status every second
        # set -g status-interval 1
        set -g status-interval 5


        # Configure elements to show on left side of the status bar
        set -g status-left ""
        set -g status-left-length 20
        set -g status-left ' #{?client_prefix,#[fg=#5ef1ff] LDR ,#[fg=green] #S} | '

        # Center window list for clarity
        set -g status-justify left
        set-window-option -g window-status-separator ""

        # Configure contents in current window status
        setw -g window-status-current-format " <#I:#W#F> "

        # Configure contents in other window status
        setw -g window-status-format " #I:#W#F "

        # Configure elements to show on right side of the status bar
        set -g status-right ""
        set -g status-right-length 70

        set -g status-right '\
            #[fg=green] \
            󰇚 #{download_speed} \
            󰕒 #{upload_speed} | \
             #{pane_current_command} | \
            󰥔 #(TZ="America/Los_Angeles" date +"%%a %%D %%l:%%M%%p")'
    ##}}

    ## Color {{
        # Set pane colors for the active pane
        set -g pane-border-style fg=green
        set -g pane-active-border-style fg=white

        # Set message text colors
        set -g message-style fg=yellow,bg=default

        # Set colors for the status bar
        set -g status-style fg=white,bg=default

        # window title colors; non active
        # set-window-option -g window-status-style fg=cyan,bg=default
        set-window-option -g window-status-style fg="#ffffff",bg="#3c4048"

        # Window title colors; last active
        set-window-option -g window-status-last-style fg="#ffffff",bg="#3c4048"

        # window title colors; active
        set-window-option -g window-status-current-style fg=black,bg=cyan

        # window title colors; activity
        set-window-option -g window-status-activity-style fg=white,bg=red
    ## }}
### }}}

### Plugins {{{
    # `prefix + I` to install plugins
    # `prefix + U` to update plugins
    set -g @plugin "tmux-plugins/tpm"

    #Set Tmux plugin to resurrect every time workstation restarted
    # (Ctrl+A Ctrl+S to Save / Ctrl+A Ctrl+R to Resurrect)
    set -g @plugin "tmux-plugins/tmux-resurrect"
    set -g @plugin "tmux-plugins/tmux-continuum"

    # Show network stats (up/down speeds)
    set -g @plugin "tmux-plugins/tmux-net-speed"

    # `prefix + *` - Kills process in current pane
    set -g @plugin "tmux-plugins/tmux-cowboy"

    # Automatically restore tmux windows when tmux starts.
    set -g @continuum-restore "on"
    # Don't auto-launch tmux at machine boot.  Give me a chance to gcert first.
    set -g @continuum-boot "off"
    # Preserves what was readable in each pane.
    set -g @resurrect-capture-pane-contents "on"
    set -g @resurrect-strategy-vim "session"
    set -g @resurrect-dir "~/.config/tmux/resurrect"

    # # Vim / NVim compatibility
    # - This is cool, but I so rarely use splits, and it seems to make tmux laggy when switching panes
    # set -g @plugin "christoomey/vim-tmux-navigator"
    #
    # set -g @vim_navigator_mapping_left  "M-Left"
    # set -g @vim_navigator_mapping_right "M-Right"
    # set -g @vim_navigator_mapping_up    "M-Up"
    # set -g @vim_navigator_mapping_down  "M-Down"
    # set -g @vim_navigator_mapping_prev ""
    #
    # # Switch panes using Alt-arrow without prefix
    # bind -n M-Left  select-pane -L
    # bind -n M-Right select-pane -R
    # bind -n M-Up    select-pane -U
    # bind -n M-Down  select-pane -D

    # decide whether we're in a Vim process
    # is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    #     | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

    # bind-key -n 'M-Left'  if-shell "$is_vim" 'send-keys M-Left'  'select-pane -L'
    # bind-key -n 'M-Down'  if-shell "$is_vim" 'send-keys M-Down'  'select-pane -D'
    # bind-key -n 'M-Up'    if-shell "$is_vim" 'send-keys M-Up'    'select-pane -U'
    # bind-key -n 'M-Right' if-shell "$is_vim" 'send-keys M-Right' 'select-pane -R'

    # tmux_version='$(tmux -V | sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'

    # if-shell -b '[ "$(echo "$tmux_version < 3.0" | bc)" = 1 ]' \
    #     "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\'  'select-pane -l'"
    # if-shell -b '[ "$(echo "$tmux_version >= 3.0" | bc)" = 1 ]' \
    #     "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\\\'  'select-pane -l'"

    # bind-key -n 'C-Space' if-shell "$is_vim" 'send-keys C-Space' 'select-pane -t:.+'

    bind-key -T copy-mode-vi 'M-Left'  select-pane -L
    bind-key -T copy-mode-vi 'M-Down'  select-pane -D
    bind-key -T copy-mode-vi 'M-Up'    select-pane -U
    bind-key -T copy-mode-vi 'M-Right' select-pane -R
    # bind-key -T copy-mode-vi 'C-\' select-pane -l
    # bind-key -T copy-mode-vi 'C-Space' select-pane -t:.+
### }}}

### Initialize TPM and Source Plugins
run '#{TMUX_PLUGIN_MANAGER_PATH}/tpm/tpm'
